name: Node.js CI/CD

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: [ubuntu-latest]

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
    - name: Login to docker hub
      run: docker login -u ${{secrets.DOCKER_USER }} -p ${{DOCKER_PASSWORD}}
    - name: Build docker image
      run: docker build -t soyket/nodejs-app .
    - name: Publish image to docker hub
      run: docker push soyket/nodejs-app:latest

  deploy:
    needs: build  
    runs-on: [aws-ec2]

    steps:
    - name: Pull image from docker hub
      run: docker pull soyket/nodejs-app:latest
    - name: Delete old docker container
      run: docker rm -f nodejs-app-container
    - name: Run docker container
      run: docker run -d -p 4000:4000 --name nodejs-app-container soyket/nodejs-app
